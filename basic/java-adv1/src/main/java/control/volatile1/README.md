# 메모리 가시성 Memory Visibility

- 멀티스레드 환경에서 한 스레드가 변경한 값이 다른 스레드에서 언제 보이는지에 대한 것을 메모리 가시성이라고 한다.
- 메모리에 변경한 값이 보이는가, 보이지 않는가에 대한 문제

## 메모리 동기화

- 메인 메모리의 변경 내역을 캐시 메모리에 가져오는 시점은 언제일까?
- CPU 설계 방식과 실행 환경에 따라 다를 수 있다. (즉시 될 수도 있고, 몇 밀리초 후에 될 수도, 몇 초 후가 될 수도, 평생 되지 않을 수도 있다.)
- 주로 컨텍스트 스위칭이 될 때, 캐시 메모리도 함께 갱신되는데, 이 부분도 환경에 따라 달라질 수 있다.
  - `Thread.sleep()`, 콘솔에 출력 등을 할 때 스레드가 잠깐 쉬는데, 이럴 때 컨텍스트 스위칭이 되면서 주로 갱신된다.
  - 하지만 이것이 갱신을 보장하는 것은 아니다.

## 성능 차이

- 예시 코드에서 확인해보면, `volatile`을 사용하면 거의 5배 느린 것을 확인할 수 있다.

--- 

# 자바 메모리 모델 Java Memory Model

- 자바 프로그램이 어떻게 메모리에 접근하고 수정할 수 있는지를 규정하며, 특히 멀티스레드 프로그래밍에서 스레드 간의 상호작용을 정의.
- 핵심은 여러 스레드들의 작업 순서를 보장하는 `happends-before` 관계에 대한 정의다.

## happens-before

- 자바 메모리 모델에서 스레드 간의 작업 순서를 정의하는 개념이다.
- ex) 만약 A 작업이 B 작업보다 happens-before 관계에 있다면, A 작업에서의 모든 메모리 변경 사항은 B 작업에서 볼 수 있다.
- happens-before 관계 특징
  - 한 동작이 다른 동작보다 먼저 발생함을 보장한다.
  - 스레드 간의 메모리 가시성을 보장하는 규칙이다.
  - 한 스레드의 작업을 다른 스레드에서 볼 수 있게 된다.
  - 즉, 한 스레드에서 수행한 작업을 다른 스레드가 참조할 때 최신 상태가 보장되는 것이다.

## happens-before 관계가 발생하는 경우

- 그냥 그런 거구나 알고 넘어가면 된다.
